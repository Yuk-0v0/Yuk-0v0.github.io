<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="light"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.webp"><link rel="icon" href="/img/favicon.webp"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#20263d"><meta name="description" content="笔记而已，温故而知新。"><meta name="author" content="Yuk"><meta name="keywords" content=""><meta name="description" content="笔记而已，温故而知新。"><meta property="og:type" content="article"><meta property="og:title" content="Flask数据库笔记"><meta property="og:url" content="https://blog.yuk7.com/2020/02/02/Flask%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/index.html"><meta property="og:site_name" content="☾ Yuk的部落格"><meta property="og:description" content="笔记而已，温故而知新。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/%E4%BD%BF%E7%94%A8Flask-SQLAlchemy%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%931.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%209.06.12%20AM.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%2010.53.04%20AM.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%204.54.13%20PM.png"><meta property="article:published_time" content="2020-02-02T23:43:00.000Z"><meta property="article:modified_time" content="2021-12-02T13:59:12.621Z"><meta property="article:author" content="Yuk"><meta property="article:tag" content="Flask"><meta property="article:tag" content="Python"><meta property="article:tag" content="Database"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/%E4%BD%BF%E7%94%A8Flask-SQLAlchemy%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%931.png"><title>Flask数据库笔记 - ☾ Yuk的部落格</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark-reasonable.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/pixiv_icon/iconfont.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"blog.yuk7.com",root:"/",version:"1.8.12",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"always",icon:"#"},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname"}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="☾ Yuk的部落格" type="application/atom+xml">
</head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>☾ Yuk的部落格</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/cover_banner.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.5)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Flask数据库笔记"></span><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-02-02 23:43" pubdate>2020年2月2日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 8.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 25 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Flask数据库笔记</h1><p class="note note-info">本文最后更新于：2021年12月2日 下午</p><div class="markdown-body"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>想了想，整体笔记这个表述还是太过于笼统了，单独拎出来也方便查询复盘。<br>这里我们只是涉及到Flask-SQLAlchemy的使用层次上，深入的架构关系处理按下不表。<br>以下内容参考摘抄于《Flask+Web开发实战》，是本好书，感谢作者李辉。</p><h2 id="初始配置"><a href="#初始配置" class="headerlink" title="初始配置"></a>初始配置</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; pip install flask-sqlclchemy<br></code></pre></div></td></tr></table></figure><h3 id="扩展的初始化"><a href="#扩展的初始化" class="headerlink" title="扩展的初始化:"></a>扩展的初始化:</h3><p>实例化Flask-SQLAlchemy提供的SQLAlchemy类，传入程序实例app，完成。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_sqlalchemy <span class="hljs-keyword">import</span> SQLAlchemy<br>app = Flask(__name__)<br>db = SQLAlchemy(app)<br></code></pre></div></td></tr></table></figure><h2 id="连接数据库服务器"><a href="#连接数据库服务器" class="headerlink" title="连接数据库服务器"></a>连接数据库服务器</h2><p><img src="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/%E4%BD%BF%E7%94%A8Flask-SQLAlchemy%E7%AE%A1%E7%90%86%E6%95%B0%E6%8D%AE%E5%BA%931.png" srcset="/img/loading.gif" lazyload alt="各类数据库URI"></p><h3 id="配置SQLite数据库URI"><a href="#配置SQLite数据库URI" class="headerlink" title="配置SQLite数据库URI"></a>配置SQLite数据库URI</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br> ...<br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = os.getenv(<span class="hljs-string">&#x27;DATABASE_URL&#x27;</span>, <span class="hljs-string">&#x27;sqlite:///&#x27;</span> + os.path.join(app.root_path, <span class="hljs-string">&#x27;db.sqlite3&#x27;</span>))<br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="hljs-literal">False</span><br></code></pre></div></td></tr></table></figure><p>这里图方便用的就是SQLite，只需要提供文件路径即可[这里是app同路径下db.sqlite3]。</p><p>但在生产环境下更换到其他类型的DBMS时，数据库URL会包含敏感信息，所以这里优先从环境变量DATABASE_URL获取。</p><p>【注意不同操作系统下斜杆数不一致】所以也就玩具项目图方便用下，其他情况下还是用Mysql等更专业的吧。</p><h3 id="配置Mysql数据库URI"><a href="#配置Mysql数据库URI" class="headerlink" title="配置Mysql数据库URI"></a>配置Mysql数据库URI</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br> ...<br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = os.getenv(<span class="hljs-string">&#x27;DATABASE_URL&#x27;</span>,<span class="hljs-string">&#x27;mysql://root:password@127.0.0.1:3306/database_name&#x27;</span>)<br>app.config[<span class="hljs-string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="hljs-literal">False</span><br></code></pre></div></td></tr></table></figure><p>需要提前开启Mysql服务器以及创建好database_name。</p><p>安装并初始化Flask-SQLAlchemy后，启动程序时会看到命令行下有一行警告信息。<br>这是因为Flask-SQLAlchemy建议你设置SQLALCHEMY_TRACK_MODIFICATIONS 配置变量，这个配置变量决定是否追踪对象的修改，这用于Flask-SQLAlchemy的事件通知系统。</p><p>这个配置键的默认值为None，如果没有特殊需要，我们可以把它设为 False来关闭警告信息:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">app.config[<span class="hljs-string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="hljs-literal">False</span><br></code></pre></div></td></tr></table></figure><h2 id="定义数据库模型"><a href="#定义数据库模型" class="headerlink" title="定义数据库模型"></a>定义数据库模型</h2><p><img src="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%209.06.12%20AM.png" srcset="/img/loading.gif" lazyload alt="数据库字段"></p><p>这里我就演示了下几个常用的</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br> ...<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Note</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    author = db.Column(db.String(<span class="hljs-number">25</span>), nullable=<span class="hljs-literal">False</span>)<br>    created_time = db.Column(db.DateTime, default=datetime.now, nullable = <span class="hljs-literal">False</span>)<br>    body = db.Column(db.Text,default=<span class="hljs-string">&#x27;Write Something&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>默认情况下，Flask-SQLAlchemy会根据模型类的名称生成一个表名称，生成规则如下:<br>Message –&gt; message # 单个单词转换为小写<br>FooBar –&gt; foo_bar # 多个单词转换为小写并使用下划线分隔 Note类对应的表名称即note</p><p>如果你想自己指定表名称，可以通过定义 <code>__tablename__</code>属性来实现。</p><h2 id="创建数据库表"><a href="#创建数据库表" class="headerlink" title="创建数据库表"></a>创建数据库表</h2><p>定义好模型后就可以直接创建了。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> click<br> ...<br><span class="hljs-meta">@app.cli.command()</span><br><span class="hljs-meta">@click.option(<span class="hljs-params"><span class="hljs-string">&#x27;--drop&#x27;</span>, is_flag=<span class="hljs-literal">True</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Create after drop.&#x27;</span></span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initdb</span>(<span class="hljs-params">drop</span>):</span><br>    <span class="hljs-keyword">if</span> drop:<br>        click.confirm(<span class="hljs-string">&#x27;This operation will delete the database, do you want to continue?&#x27;</span>, abort=<span class="hljs-literal">True</span>)<br>        db.drop_all()<br>        click.echo(<span class="hljs-string">&#x27;Drop tables.&#x27;</span>)<br>    db.create_all()<br>    click.echo(<span class="hljs-string">&#x27;Initialized database.&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>这里自定义了个flask命令<code>flask initdb</code>，用click还添加了个<code>--drop</code>的参数。</p><p>但是我们这里为了让数据库中实际的表同步数据模型的变化【添加或删除字段，修改字段的名称和类型之类的】是直接暴力的db.drop_all()后再重新db.create_all()，会直接清空表中原有的数据，迁移表原有数据后文中写。</p><h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><p>为了方便，接下来使用flask bash进行演示，在此之前我们先将自己定义的数据库模型类以及db手动传入到上下文中。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 传入bash上下文</span><br><span class="hljs-meta">@app.bash_context_processor</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_bash_context</span>():</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>(db=db, Note=Note)<br></code></pre></div></td></tr></table></figure><p>终端进入项目所在路径执行以下命令。</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; flask initdb --drop<br>This operation will delete the database, <span class="hljs-keyword">do</span> you want to <span class="hljs-built_in">continue</span>? [y/N]: y<br>Drop tables.<br>Initialized database.<br>&gt; flask bash<br>Python 3.7.5 (default, Nov 29 2019, 17:17:51) <br>[Clang 11.0.0 (clang-1100.0.20.17)] on darwin<br>App: app [production]<br>Instance: /Users/Mosaic/Programming/Flask/instance<br>&gt;&gt;&gt;<br></code></pre></div></td></tr></table></figure><p>用上一小节的命令<code>flask initdb --drop</code>我们先同步好了模型表，然后进入<code>flask bash</code> 。</p><p>【<strong>下文中<code>&gt;&gt;&gt;</code>开头的都代表是在flask shell模式中</strong>】<br>增删改查。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>note1 = Note(body=<span class="hljs-string">&#x27;hello&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>note2 = Note(body=<span class="hljs-string">&#x27;world&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.add(note1) <span class="hljs-comment"># 增</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.add(note2)<br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.commit() <span class="hljs-comment"># 每次更改都要commit才能同步到数据库</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.delete(note1) <span class="hljs-comment"># 删</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.commit()<br><span class="hljs-meta">&gt;&gt;&gt; </span>note1.body = <span class="hljs-string">&#x27;giao!&#x27;</span> <span class="hljs-comment"># 改</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>db.session.commit()<br><span class="hljs-meta">&gt;&gt;&gt; </span>Note.query.filter_by(body=<span class="hljs-string">&#x27;giao!&#x27;</span>).first() == note1 <span class="hljs-comment"># 查</span><br><span class="hljs-literal">True</span><br></code></pre></div></td></tr></table></figure><p>一般来说，一个完整的查询遵循下面的模式: &lt;模型类&gt;.query.&lt;过滤方法&gt;.&lt;查询方法&gt;</p><p><img src="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%2010.53.04%20AM.png" srcset="/img/loading.gif" lazyload alt="过滤器"> 和filter()方法相比，filter_by()方法更易于使用。</p><p>在filter_by() 方法中，你可以使用关键字表达式来指定过滤规则。更方便的是，你可以在这个过滤器中直接使用字段名称。</p><p>下面的示例使用filter_by()过滤器完成了同样的任务:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">Note.query.filter_by(body=<span class="hljs-string">&#x27;SHAVE&#x27;</span>).first()<br><span class="hljs-comment"># 等价于 Note.query.filter(Note.body=&#x27;SHAVE&#x27;).first()</span><br></code></pre></div></td></tr></table></figure><p>其他的不一一举例了。</p><h2 id="建立模型之间几种基础的关系模式"><a href="#建立模型之间几种基础的关系模式" class="headerlink" title="建立模型之间几种基础的关系模式"></a>建立模型之间几种基础的关系模式</h2><h3 id="单向和双向关系"><a href="#单向和双向关系" class="headerlink" title="单向和双向关系"></a>单向和双向关系</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Writer</span>(<span class="hljs-params">db.Model</span>):</span>    <br>  <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    name = db.Column(db.String(<span class="hljs-number">70</span>), unique=<span class="hljs-literal">True</span>)<br>    books = db.relationship(<span class="hljs-string">&#x27;Book&#x27;</span>, back_populates=<span class="hljs-string">&#x27;writer&#x27;</span>)<br>    <span class="hljs-comment"># books = db.relationship(&#x27;Book&#x27;)</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    title = db.Column(db.String(<span class="hljs-number">50</span>), index=<span class="hljs-literal">True</span>)<br>    writer_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;writer.id&#x27;</span>))<br>    writer = db.relationship(<span class="hljs-string">&#x27;Writer&#x27;</span>, back_populates=<span class="hljs-string">&#x27;books&#x27;</span>)<br>    <span class="hljs-comment"># writer = db.relationship(&#x27;Writer&#x27;)    </span><br></code></pre></div></td></tr></table></figure><p>这里我们定义了两个模型，都定义了db.relationship relationship()。</p><p>函数的第一个参数为关系另一侧的模型名称，在Writer中它会告诉SQLAlchemy将Writer类与Book类建立关系。</p><p>如果db.relationship只被定义在Writer中，而Book中没有，就叫单向关系【只能从Writer查询到books，不能从Book方向查询自己的Writer】，两边都有就是双向关系【双方可以互查】。</p><p>而back_populates参数是用来连接两边的relationship的，值为对面关系名字，从而实现<strong>未commit之前</strong>两边关系的同步。</p><p>【例如删掉了Writer A的Book B，Book B的Writer A也会被同步删除】，但是不管加没加back_populates参数，commit之后两边关系总会同步好的【之所以加重<code>未commit之前</code>是因为自己一个个测试出来的…当初对back_populates这个参数有点疑惑坑，涉及到了后面的级联】</p><p>其他参数如下，不一一举例了，backref是隐式双向，不推荐，uselist可以用在一对一关系中，secondary用在多对多关系中。</p><p><img src="https://cdn.jsdelivr.net/gh/yuk7-0v0/wp_cdn_resources/picBed/Screen%20Shot%202020-02-22%20at%204.54.13%20PM.png" srcset="/img/loading.gif" lazyload alt="各种参数"></p><p>【下面几种关系都默认使用双向关系】</p><h3 id="一对多-多对一"><a href="#一对多-多对一" class="headerlink" title="一对多/多对一"></a>一对多/多对一</h3><p>定义关系的第一步是创建外键。外键是(foreign key)用来在A表存储B表的主键值以便和B表建立联系的关系字段。</p><p>因为外键只能存储单一数据(标量)，所以<strong>外键总是在“多”这一侧定义</strong>。</p><p>多本书属于同一个作者，所以我们需要为每本书添加外键存储作者的主键值以指向对应的作者。</p><p>在Book模型中，我们定义一 个writer_id字段作为外键:</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">db.Model</span>):</span><br>  ...<br>writer_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;writer.id&#x27;</span>))<br></code></pre></div></td></tr></table></figure><p>这个字段使用db.ForeignKey类定义为外键，传入关系另一侧的表名和主键字段名，即writer.id。</p><p>实际的效果是将book表的writer_id的值限制为Writer表的id列的值。</p><p>它将用来存储Writer表中记录的主键值 再加上双向关系，一个一对多/多对一就完成了。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Writer</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    name = db.Column(db.String(<span class="hljs-number">70</span>), unique=<span class="hljs-literal">True</span>)<br>    books = db.relationship(<span class="hljs-string">&#x27;Book&#x27;</span>, back_populates=<span class="hljs-string">&#x27;writer&#x27;</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    title = db.Column(db.String(<span class="hljs-number">50</span>), index=<span class="hljs-literal">True</span>)<br>    writer_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;writer.id&#x27;</span>)) <br>    writer = db.relationship(<span class="hljs-string">&#x27;Writer&#x27;</span>, back_populates=<span class="hljs-string">&#x27;books&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>当Writer查询books时，会返回所有Book.writer_id与Writer.id一致的Book【返回列表】，而当Book查询Writer时，会返回Writer.id与writer_id一致的Writer【返回单个值】。</p><h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>一对一就是再一对多/多对一的基础上加上了个参数。</p><p>下面假设一个作者一生只写一本书，一本书也只能有一个作者</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Writer</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    name = db.Column(db.String(<span class="hljs-number">70</span>), unique=<span class="hljs-literal">True</span>)<br>    book = db.relationship(<span class="hljs-string">&#x27;Book&#x27;</span>, back_populates=<span class="hljs-string">&#x27;writer&#x27;</span>, uselist=<span class="hljs-literal">False</span>)<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>)<br>    title = db.Column(db.String(<span class="hljs-number">50</span>), index=<span class="hljs-literal">True</span>)<br>    writer_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;writer.id&#x27;</span>)) <br>    writer = db.relationship(<span class="hljs-string">&#x27;Writer&#x27;</span>, back_populates=<span class="hljs-string">&#x27;books&#x27;</span>)<br></code></pre></div></td></tr></table></figure><p>在Writer的relationship加上了uselist=False，这将表示只能返回单个值了。</p><h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>需要额外定义一个表来处理两边的外键对应关系。</p><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">association_table = db.Table(<span class="hljs-string">&#x27;association&#x27;</span>,db.Column(<span class="hljs-string">&#x27;student_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;student.id&#x27;</span>)),db.Column(<span class="hljs-string">&#x27;teacher_id&#x27;</span>, db.Integer, db.ForeignKey(<span class="hljs-string">&#x27;teacher.id&#x27;</span>))<br>)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>) <br>    name = db.Column(db.String(<span class="hljs-number">70</span>), unique=<span class="hljs-literal">True</span>) <br>    grade = db.Column(db.String(<span class="hljs-number">20</span>))<br>    teachers = db.relationship(<span class="hljs-string">&#x27;Teacher&#x27;</span>,<br>    secondary=association_table, back_populates=<span class="hljs-string">&#x27;students&#x27;</span>)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span>(<span class="hljs-params">db.Model</span>):</span><br>    <span class="hljs-built_in">id</span> = db.Column(db.Integer, primary_key=<span class="hljs-literal">True</span>) <br>    name = db.Column(db.String(<span class="hljs-number">70</span>), unique=<span class="hljs-literal">True</span>) <br>    office = db.Column(db.String(<span class="hljs-number">20</span>))<br></code></pre></div></td></tr></table></figure><h2 id="迁移数据库"><a href="#迁移数据库" class="headerlink" title="迁移数据库"></a>迁移数据库</h2><p>我们使用Flask-Migrate来实现保留数据更改表。</p><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; pip install flask-migrate<br></code></pre></div></td></tr></table></figure><h3 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask<br><span class="hljs-keyword">from</span> flask_sqlalchemy <span class="hljs-keyword">import</span> SQLAlchemy<br><span class="hljs-keyword">from</span> flask_migrate <span class="hljs-keyword">import</span> Migrate<br>app = Flask(__name__)<br> ...<br>db = SQLAlchemy(app)<br>migrate = Migrate(app, db) <span class="hljs-comment"># 在db对象创建后调用</span><br></code></pre></div></td></tr></table></figure><h3 id="创建迁移环境"><a href="#创建迁移环境" class="headerlink" title="创建迁移环境"></a>创建迁移环境</h3><p>在开始迁移数据之前，需要先使用下面的命令创建一个迁移环境:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; flask db init<br></code></pre></div></td></tr></table></figure><h3 id="生成迁移脚本"><a href="#生成迁移脚本" class="headerlink" title="生成迁移脚本"></a>生成迁移脚本</h3><p>使用migrate子命令可以自动生成迁移脚本:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; flask db migrate -m <span class="hljs-string">&quot;add note timestamp&quot;</span><br>    ...<br>INFO [alembic.autogenerate.compare] Detected added column <span class="hljs-string">&#x27;message.timestamp</span><br><span class="hljs-string">Generating /Path/to/your/database/migrations/versions/c52a02014635_add note_timestamp.py ... done</span><br></code></pre></div></td></tr></table></figure><p>这条命令可以简单理解为在flask里对数据库(db)进行迁移(migrate)，-m 选项用来添加迁移备注信息。</p><p>从上面的输出信息我们可以看到，Alembic检测出了模型的变化:表note新添加了一个timestamp列，并且相应生成了一个迁移脚本 c52a02014635_add_note_timestamp.py<br>【迁移命令是由Alembic自动生成的，其中可能包含错误，所以有必要在生成后检查一下】</p><p>因为每一次迁移都会生成新的迁移脚本，而且Alembic为每一次迁移都生成了修订版本(revision)ID，所以数据库可以恢复到修改历史中的任一点。</p><p>正因为如此，迁移环境中的文件也要纳入版本控制。</p><p>有些复杂的操作无法实现自动迁移，这时可以使用revision命令手动创建迁移脚本。<br>这同样会生成一个迁移脚本，不过脚本中的upgrade()和downgrade()函数都是空的。</p><p>你需要使用Alembic提供的Operations对象指令在这两个函数中实现具体操作，具体可以访问Alembic官方文档查看。</p><h3 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h3><p>生成了迁移脚本后，使用upgrade子命令即可更新数据库:</p><figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">&gt; flask db upgrade <br>...INFO [alembic.runtime.migration] Running upgrade -&gt; c52a02014635, add note timestamp<br></code></pre></div></td></tr></table></figure><p>如果还没有创建数据库和表，这个命令会自动创建；</p><p>如果已经创建，则会在不损坏数据的前提下执行更新。<br>如果你想回滚迁移，那么可以使用downgrade命令(降级)，它会撤销最后一 次迁移在数据库中的改动，这在开发时非常有用。</p><p>比如，当你执行upgrade命令后,发现某些地方出错了，这时就可以执行flask db downgrade命令进行回滚，删除对应的迁移脚本，重新生成迁移脚本后再进行更新(upgrade)。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>还有一些什么级联操作，事件监听之类的没有提到……，写笔记的时间比学习内容时间都要多是好事还是坏事，emmmmm，不过思路还是清晰了，管他呢~</p></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/">编程笔记</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/Flask/">Flask</a> <a class="hover-with-bg" href="/tags/Python/">Python</a> <a class="hover-with-bg" href="/tags/Database/">Database</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/2021/11/13/%E4%BD%BF%E7%94%A8AirtestIDE%E5%92%8CiOS-Tagent%E5%AE%9E%E7%8E%B0iOS%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC/"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">使用AirtestIDE和iOS-Tagent实现iOS端自动化脚本</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2019/11/29/Python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E5%A4%A7%E6%9D%82%E7%83%A9/"><span class="hidden-mobile">Python虚拟环境大杂烩</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div class="disqus" style="width:100%"><div id="disqus_thread"></div><script>Fluid.utils.loadComments("#disqus_thread",(function(){Fluid.utils.createCssLink("https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqusjs.css"),Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqus.js",(function(){new DisqusJS({shortname:"yuk-0v0",apikey:"w8Onz9Y9ZK49dApam37Ra7uv7wIbtMyR5qELyAwt8mol5BxsmvHILzrMetxayvSv"})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></div></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/boot.js"></script></body></html>